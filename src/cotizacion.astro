---
// src/pages/cotizacion.astro
import Base from "../layouts/Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

export const prerender = true; // Esta p√°gina puede ser est√°tica
---

<Base>
  <Header slot="header" />
  
  <main class="bg-zinc-50 text-zinc-900 min-h-screen py-16">
    <div class="container-max">
      <div class="max-w-2xl mx-auto">
        
        <!-- T√≠tulo -->
        <div class="text-center mb-10">
          <h1 class="text-4xl md:text-5xl font-extrabold text-zinc-800 mb-4">
            Solicita tu Cotizaci√≥n
          </h1>
          <p class="text-lg text-zinc-600">
            Completa el formulario y te contactaremos lo antes posible
          </p>
        </div>

        <!-- Formulario -->
        <div class="bg-white rounded-2xl shadow-lg p-8 md:p-10">
          <form id="cotizacion-form" class="space-y-6">
            
            <!-- Nombre -->
            <div>
              <label for="nombre" class="block text-sm font-semibold text-zinc-700 mb-2">
                Nombre completo *
              </label>
              <input 
                type="text" 
                id="nombre"
                name="nombre" 
                required
                placeholder="Ej: Juan P√©rez"
                class="w-full px-4 py-3 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
              />
            </div>

            <!-- Email -->
            <div>
              <label for="email" class="block text-sm font-semibold text-zinc-700 mb-2">
                Email *
              </label>
              <input 
                type="email" 
                id="email"
                name="email" 
                required
                placeholder="tu@email.com"
                class="w-full px-4 py-3 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
              />
            </div>

            <!-- Tel√©fono -->
            <div>
              <label for="telefono" class="block text-sm font-semibold text-zinc-700 mb-2">
                Tel√©fono *
              </label>
              <input 
                type="tel" 
                id="telefono"
                name="telefono" 
                required
                placeholder="(809) 123-4567"
                class="w-full px-4 py-3 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
              />
            </div>

            <!-- Servicio -->
            <div>
              <label for="servicio" class="block text-sm font-semibold text-zinc-700 mb-2">
                Servicio requerido *
              </label>
              <select 
                id="servicio"
                name="servicio" 
                required
                class="w-full px-4 py-3 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
              >
                <option value="">Selecciona un servicio</option>
                <option value="Desinsectaci√≥n">Desinsectaci√≥n (Cucarachas, hormigas, mosquitos)</option>
                <option value="Desratizaci√≥n">Desratizaci√≥n (Control de roedores)</option>
                <option value="Sanitizaci√≥n / Desinfecci√≥n">Sanitizaci√≥n / Desinfecci√≥n</option>
                <option value="Tratamiento antitermitas">Tratamiento antitermitas</option>
                <option value="Limpieza de tanques">Limpieza de tanques</option>
                <option value="Control de palomas">Control de palomas</option>
              </select>
            </div>

            <!-- Mensaje -->
            <div>
              <label for="mensaje" class="block text-sm font-semibold text-zinc-700 mb-2">
                Cu√©ntanos sobre tu problema (opcional)
              </label>
              <textarea 
                id="mensaje"
                name="mensaje" 
                rows="4"
                placeholder="Describe tu situaci√≥n con las plagas..."
                class="w-full px-4 py-3 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none"
              ></textarea>
            </div>

            <!-- Bot√≥n y Mensaje de Respuesta -->
            <div class="space-y-4">
              <button 
                type="submit" 
                id="submit-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
              >
                <span id="btn-text">Enviar Cotizaci√≥n</span>
              </button>

              <div id="mensaje-respuesta" class="hidden"></div>
            </div>

          </form>

          <!-- Informaci√≥n de contacto alternativa -->
          <div class="mt-8 pt-8 border-t border-zinc-200">
            <p class="text-center text-sm text-zinc-600 mb-4">
              ¬øPrefieres contactarnos directamente?
            </p>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
              <a 
                href="tel:+18097777586"
                class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-zinc-100 hover:bg-zinc-200 rounded-lg transition"
              >
                üìû 809-777-7586
              </a>
              <a 
                href="https://wa.me/18097777586"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-100 hover:bg-green-200 rounded-lg transition"
              >
                üí¨ WhatsApp
              </a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </main>

  <Footer slot="footer" />
</Base>

<script>
  // Obtener elementos del DOM
  const form = document.getElementById('cotizacion-form') as HTMLFormElement;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text') as HTMLSpanElement;
  const mensajeDiv = document.getElementById('mensaje-respuesta') as HTMLDivElement;

  // Manejar el env√≠o del formulario
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Cambiar estado del bot√≥n
    btn.disabled = true;
    btnText.textContent = 'Enviando...';
    mensajeDiv.classList.add('hidden');
    
    // Recopilar datos del formulario
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
      // Hacer la petici√≥n al endpoint
      const response = await fetch('/api/send-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      // Mostrar mensaje seg√∫n resultado
      if (response.ok && result.success) {
        // √âxito
        mensajeDiv.innerHTML = `
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-800 font-semibold">‚úÖ ¬°Cotizaci√≥n enviada con √©xito!</p>
            <p class="text-green-700 text-sm mt-1">Te contactaremos pronto. Revisa tu email.</p>
          </div>
        `;
        mensajeDiv.classList.remove('hidden');
        form.reset(); // Limpiar formulario
        
        // Scroll al mensaje
        mensajeDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
      } else {
        // Error del servidor
        mensajeDiv.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-800 font-semibold">‚ùå Error al enviar</p>
            <p class="text-red-700 text-sm mt-1">${result.error || 'Intenta de nuevo o cont√°ctanos por WhatsApp'}</p>
          </div>
        `;
        mensajeDiv.classList.remove('hidden');
      }
      
    } catch (error) {
      // Error de red
      console.error('Error:', error);
      mensajeDiv.innerHTML = `
        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-800 font-semibold">‚ùå Error de conexi√≥n</p>
          <p class="text-red-700 text-sm mt-1">Verifica tu internet e intenta de nuevo</p>
        </div>
      `;
      mensajeDiv.classList.remove('hidden');
      
    } finally {
      // Restaurar bot√≥n
      btn.disabled = false;
      btnText.textContent = 'Enviar Cotizaci√≥n';
    }
  });
</script>
