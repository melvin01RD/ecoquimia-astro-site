---
const links = [
  { href: "/", label: "Inicio" },
  { href: "/nosotros", label: "Nosotros" },
  { href: "/services", label: "Servicios" },
  { href: "/cotizacion", label: "Cotización" },
  { href: "/aprende-de-las-plagas", label: "Aprende de las plagas" },
  { href: "/contact", label: "Contacto" },
  { href: "/politicas", label: "Políticas" },
];
const { pathname } = Astro.url;
---

<header class="site-header sticky top-0 z-50 bg-zinc-900 text-white border-b border-white/10" data-js="header">
  <div class="container-max flex items-center justify-between h-20">
    <!-- Logo -->
    <a href="/" class="inline-flex items-center gap-2 no-underline flex-shrink-0" aria-label="Inicio">
      <img
        src="/logo/ecoq-logo@2x-transparent.png"
        alt="Ecoquimia — Creamos un Ambiente sin Plagas"
        class="h-12 w-auto select-none md:h-14"
        width="115" height="64" loading="eager" decoding="async" fetchpriority="high"
      />

    <style is:global>
  /* Forzar visibilidad correcta del nav de escritorio frente a reglas globales */
  @media (max-width: 767.98px){
    .site-header .nav-desktop{ display: none !important; }
  }
  @media (min-width: 768px){
    .site-header .nav-desktop{ display: flex !important; }
  }
</style>



    </a>

    <!-- Desktop nav -->
    <nav class="nav-desktop hidden md:flex items-center gap-6" aria-label="Principal">
      {links.map((l) => (
        <a
          href={l.href}
          class={`nav-link ${pathname === l.href ? "is-active" : ""} text-white/80 hover:text-white`}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <!-- Acciones mobile (derecha): WhatsApp + Burger) -->
    <div class="md:hidden flex items-center gap-2">
      <a
        href={`https://wa.me/18096172105?text=${encodeURIComponent("Hola, quiero una cotización de control de plagas.")}`}
        class="inline-flex items-center justify-center rounded-xl px-3 py-2 bg-emerald-600 text-white text-sm hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
        target="_blank" rel="noopener noreferrer" aria-label="WhatsApp"
      >
        WhatsApp
      </a>

      <button
        id="navToggle"
        type="button"
        class="inline-flex items-center justify-center rounded-xl p-2 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
        aria-label="Abrir menú"
        aria-controls="mobileMenu"
        aria-expanded="false"
      >
        <!-- icon hamburguesa -->
        <svg class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path id="burgerPath" stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Panel móvil -->
  <div
    id="mobileMenu"
    class="md:hidden hidden border-t border-white/10 bg-zinc-900/95 backdrop-blur supports-[backdrop-filter]:bg-zinc-900/80 will-change-transform"
    aria-hidden="true"
  >
    <nav class="container-max py-3" aria-label="Móvil">
      <ul class="flex flex-col">
        {links.map((l, idx) => (
          <li class={idx ? "border-t border-white/10" : ""}>
            <a
              href={l.href}
              class={`block px-3 py-3 text-base ${pathname === l.href ? "bg-white/10 text-white" : "text-white/80 hover:bg-white/10 hover:text-white"}`}
              data-close
            >
              {l.label}
            </a>
          </li>
        ))}
        <li class="border-t border-white/10">
          <a
            href={`https://wa.me/18096172105?text=${encodeURIComponent("Hola, quiero una cotización de control de plagas.")}`}
            target="_blank" rel="noopener noreferrer"
            class="block px-3 py-3 text-base text-white/90 hover:bg-white/10 hover:text-white"
            data-close
          >
            WhatsApp
          </a>
        </li>
      </ul>
      <!-- safe area bottom para iOS -->
      <div class="pb-[max(env(safe-area-inset-bottom),0.5rem)]"></div>
    </nav>
  </div>
</header>

<script is:inline>
  // Registramos los listeners cuando el hilo esté libre (no bloquear LCP)
  (window.requestIdleCallback || setTimeout)(() => {
    const btn = document.getElementById('navToggle');
    const panel = document.getElementById('mobileMenu');
    const burgerPath = document.getElementById('burgerPath');

    if (!btn || !panel) return;

    const mqDesktop = window.matchMedia('(min-width: 768px)');

    function lockBodyScroll(lock) {
      // Solo en mobile; en desktop jamás abrimos este menú
      if (mqDesktop.matches) return;
      document.documentElement.classList.toggle('overflow-hidden', lock);
      document.body.classList.toggle('overflow-hidden', lock);
    }

    function setOpen(open) {
      btn.setAttribute('aria-expanded', String(open));
      panel.classList.toggle('hidden', !open);
      panel.setAttribute('aria-hidden', String(!open));
      lockBodyScroll(open);

      // Cambia icono (hamburguesa <-> X)
      if (burgerPath) {
        burgerPath.setAttribute(
          'd',
          open ? 'M6 6l12 12M18 6l-12 12' : 'M4 6h16M4 12h16M4 18h16'
        );
      }
    }

    btn.addEventListener('click', () => {
      const open = btn.getAttribute('aria-expanded') === 'true';
      setOpen(!open);
    }, { passive: true });

    // Cierra al pulsar en enlaces del panel
    panel.addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.closest('[data-close]')) setOpen(false);
    }, { passive: true });

    // Cierra con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') setOpen(false);
    });

    // Cierra al pulsar fuera
    document.addEventListener('click', (e) => {
      const open = btn.getAttribute('aria-expanded') === 'true';
      if (!open) return;
      if (!panel.contains(e.target) && !btn.contains(e.target)) setOpen(false);
    }, { passive: true });

    // Si pasamos a desktop, asegúrate de cerrar/limpiar bloqueo
    mqDesktop.addEventListener?.('change', () => setOpen(false));
  }, 1);
</script>
