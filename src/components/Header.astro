---
import { config } from "../config";

const links = [
  { href: "/", label: "Inicio" },
  { href: "/nosotros", label: "Nosotros" },
  { href: "/servicios", label: "Servicios" },
  { href: "/cotizacion", label: "Cotización" },
  { href: "/aprende-de-las-plagas", label: "Aprende de las plagas" },
  { href: "/contact", label: "Contacto" },
  { href: "/politicas", label: "Políticas" },
];
const { pathname } = Astro.url;
---

<header class="site-header sticky top-0 z-50 text-white border-b border-white/10" data-js="header">

  <style is:global>
    @media (max-width: 767.98px){ .site-header .nav-desktop{ display: none !important; } }
    @media (min-width: 768px){ .site-header .nav-desktop{ display: flex !important; } }

    /* Large screens: navbar optimization */
    @media (min-width: 1440px) {
      .site-header .navbar-container {
        max-width: 1920px;
        margin: 0 auto;
        padding: 0 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .site-header .logo-link {
        margin-right: auto;
        flex-shrink: 0;
      }

      .site-header .nav-desktop {
        margin-left: auto;
        gap: 2rem;
      }
    }

    /* Extra wide screens */
    @media (min-width: 1920px) {
      .site-header .navbar-container {
        padding: 0 5rem;
      }
    }
  </style>

  <div class="navbar-container container-max flex items-center justify-between h-20">
    <a href="/" class="logo-link inline-flex items-center gap-2 no-underline flex-shrink-0" aria-label="Inicio">
      <img
        src="/logo/logo.png"
        alt="Ecoquimia — Creamos un Ambiente sin Plagas"
        width="210" height="120"
        class="logo block h-10 md:h-12 w-auto select-none"
        loading="eager" decoding="async" fetchpriority="high"
      />
      <span class="sr-only">Ecoquimia</span>
    </a>

    <nav class="nav-desktop hidden md:flex items-center gap-6" aria-label="Principal">
      {links.map((l) => (
        <a
          href={l.href}
          class={`nav-link ${pathname === l.href ? "is-active" : ""} text-white/80 hover:text-white`}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <div class="md:hidden flex items-center gap-2">
      <button
        id="navToggle"
        type="button"
        class="inline-flex items-center justify-center rounded-xl p-2 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
        aria-label="Abrir menú"
        aria-controls="mobileMenu"
        aria-expanded="false"
      >
        <svg class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path id="burgerPath" stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
  </div>

  <div
    id="mobileMenu"
    class="md:hidden hidden border-t border-white/10 bg-zinc-900/95 backdrop-blur supports-[backdrop-filter]:bg-zinc-900/80 will-change-transform"
    aria-hidden="true"
  >
    <nav class="container-max py-3" aria-label="Móvil">
      <ul class="flex flex-col">
        {links.map((l, idx) => (
          <li class={idx ? "border-t border-white/10" : ""}>
            <a
              href={l.href}
              class={`block px-3 py-3 text-base ${pathname === l.href ? "bg-white/10 text-white" : "text-white/80 hover:bg-white/10 hover:text-white"}`}
              data-close
            >
              {l.label}
            </a>
          </li>
        ))}
        <li class="border-t border-white/10">
          <a
            href={`https://wa.me/${config.contact.phone}?text=${encodeURIComponent(config.contact.whatsappText)}`}
            target="_blank" rel="noopener noreferrer"
            class="block px-3 py-3 text-base text-white/90 hover:bg-white/10 hover:text-white"
            data-close
          >
            WhatsApp
          </a>
        </li>
      </ul>
      <div class="pb-[max(env(safe-area-inset-bottom),0.5rem)]"></div>
    </nav>
  </div>
</header>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('navToggle');
    const panel = document.getElementById('mobileMenu');
    const burgerPath = document.getElementById('burgerPath');
    if (!btn || !panel) return;

    const mqDesktop = matchMedia('(min-width: 768px)');
    const BURGER = 'M4 6h16M4 12h16M4 18h16';
    const CLOSE  = 'M6 6l12 12M6 18L18 6';

    function lockBodyScroll(lock) {
      if (mqDesktop.matches) return;
      document.documentElement.classList.toggle('overflow-hidden', lock);
      document.body.classList.toggle('overflow-hidden', lock);
    }

    function setOpen(open) {
      btn.setAttribute('aria-expanded', String(open));
      panel.classList.toggle('hidden', !open);
      panel.setAttribute('aria-hidden', String(!open));
      if (burgerPath) burgerPath.setAttribute('d', open ? CLOSE : BURGER);
      lockBodyScroll(open);
    }

    btn.addEventListener('click', () => {
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      setOpen(!isOpen);
    });

    panel.querySelectorAll('[data-close]').forEach(link => {
      link.addEventListener('click', () => setOpen(false));
    });

    mqDesktop.addEventListener('change', (e) => {
      if (e.matches) setOpen(false);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && btn.getAttribute('aria-expanded') === 'true') {
        setOpen(false);
        btn.focus();
      }
    });
  });
</script>